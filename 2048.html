<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2048</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            text-align: center;
        }

        hr {
            width: 500px;
        }

        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 auto;
            width: 500px;
            position: relative; /* Added for positioning buttons */
        }

        #title {
            font-size: 80px;
            font-weight: bold;
            padding: 10px 15px;
            color: #5e4831;
            text-align: center;
            margin: 0;
            display: block;
            float: left;
        }

        #board {
            width: 400px;
            height: 400px;
            background-color: #cdc1b5;
            border: 6px solid #bbada0;
            margin: 50px auto 0;
            display: flex;
            flex-wrap: wrap;
        }

        #login {
            position: absolute;
            right: 20px; /* Adjusted for proper positioning */
            top: 20px; /* Adjusted for proper positioning */
            font-weight: bold;
            font-size: 16px;
            padding: 5px 10px;
            background-color: #cdc1b5;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: #776e65;
        }

        #login button {
            font-weight: bold;
            font-size: 14px;
            width: 100%;
            height: 100%;
            background: none;
            border: none;
            text-decoration: none;
            cursor: pointer;
        }

        #new-game {
            position: absolute;
            right: 505px;
            top: 115px; /* Adjusted for proper positioning between "Best" and the board */
            font-weight: bold;
            width: 120px; /* Increased width for better appearance */
            font-size: 16px;
            padding: 10px 15px;
            background-color: #cdc1b5;
            cursor: pointer;
            text-align: center;
        }

        #new-game button {
            font-weight: bold;
            font-size: 14px;
            width: 100%;
            height: 100%;
            background: none;
            border: none;
            cursor: pointer;
        }

        #score-container {
            display: flex;
            justify-content: space-between;
            width: 200px;
            font-size: 18px;
            font-weight: bold;
            color: #776e65;
            position: absolute;
            top: 20px; /* Adjusted for proper positioning */
            right: 20px; /* Adjusted for proper positioning */
        }

        .score-box {
            background-color: #bbada0;
            padding: 10px 15px;
            border-radius: 5px;
            color: #f9f6f2;
            text-align: center;
        }

        .bestscore-box {
            background-color: #bbada0;
            padding: 10px 15px;
            border-radius: 5px;
            color: #f9f6f2;
            text-align: center;
        }

        .score-box span {
            display: block;
            font-size: 24px;
        }

        .bestscore-box span {
            display: block;
            font-size: 24px;
        }

        .tile {
            width: 90px;
            height: 90px;
            border: 5px solid #bbada0;
            font-size: 40px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* color of tiles */
        .x2 { background-color: #eee4da; color: #727371; }
        .x4 { background-color: #ece0ca; color: #727371; }
        .x8 { background-color: #f4b17a; color: white; }
        .x16 { background-color: #f59575; color: white; }
        .x32 { background-color: #f57c5f; color: white; }
        .x64 { background-color: #f65d3b; color: white; }
        .x128 { background-color: #edce71; color: white; }
        .x256 { background-color: #edcc63; color: white; }
        .x512 { background-color: #edc651; color: white; }
        .x1024 { background-color: #eec744; color: white; }
        .x2048 { background-color: #ecc230; color: white; }
        .x4096 { background-color: #fe3d3d; color: white; }
        .x8192 { background-color: #ff2020; color: white; }

        #game-over {
            display: none;
            background-color: rgba(0, 0, 0, 0.5);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            z-index: 1000;
        }

        #game-over button {
            padding: 10px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="header">
        <div id="title">2048</div>
        <div id="score-container">
            <div class="score-box">
                <div>Score</div>
                <span id="score">0</span>
            </div>
            <div class="bestscore-box">
                <div>Best</div>
                <span id="best">0</span>
            </div>
        </div>
    </div>
    <div id="login">
        <a href="/login">Login</a>
    </div>
    <div id="new-game">
        <button onclick="confirmNewGame()">Play New Game</button>
    </div>
    <div id="board"></div>
    <div id="container">
        <div id="board-container"></div>
    </div>
    <div id="game-over">
        <div>
            <p>Game Over! Start new game?</p>
            <button onclick="resetGame()">Start New Game</button>
        </div>  
    </div>
    <script>
        var board;
        var score = 0;
        var bestScore = 0;
        var rows = 4;
        var columns = 4;
        var highScores = [];
        var gameWon = false;

        window.onload = function() {
            setGame();
        }

        function setGame() {

            board = [
                [0, 0, 0, 0], 
                [0, 0, 0, 0], 
                [0, 0, 0, 0],
                [0, 0, 0, 0]
            ];

            document.getElementById("board").innerHTML = ""; // Clear the board

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    let tile = document.createElement("div");
                    tile.id = r.toString() + "-" + c.toString();
                    let num = board[r][c];
                    updateTile(tile, num);
                    document.getElementById("board").append(tile);
                }
            }
            // create game
            setTwo();
            setTwo();
        }

        function updateTile(tile, num) {
            tile.innerText = "";
            tile.classList.value = ""; //clearing the classList
            tile.classList.add("tile");
            if (num > 0) {
                tile.innerText = num.toString();
                if (num <= 4096) {
                    tile.classList.add("x" + num.toString());
                } else {
                    tile.classList.add("x8192");
                }
            }

            // Check for win condition whenever a tile is updated
            checkWin();
        }

        function checkWin() {
            if (gameWon) {
                return; // If the game is already won and continued, do nothing
            }

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    if (board[r][c] == 2048) {
                        if (confirm("Congratulations! You've reached 2048! Do you want to keep playing?")) {
                            gameWon = true; // Set the flag to true to allow the user to continue playing
                        } else {
                            // If the user doesn't want to continue, stop further moves
                            document.removeEventListener("keyup", handleKeyUp);
                        }
                        return;
                    }
                }
            }
        }

        document.addEventListener("keyup", handleKeyUp);

        function handleKeyUp(e) {
            let moved = false;
                if (e.code == "ArrowLeft") {
                    moved = slideLeft();
                } else if (e.code == "ArrowRight") {
                    moved = slideRight();
                } else if (e.code == "ArrowUp") {
                    moved = slideUp();
                } else if (e.code == "ArrowDown") {
                    moved = slideDown();
                }

                if (moved) {
                    setTwo(); // Only add a new tile if any tile has moved
                }
                document.getElementById("score").innerText = score;

                if (score > bestScore) {
                    bestScore = score;
                    document.getElementById("best").innerText = bestScore;
                }
                if (isGameOver()) {
                    console.log("Game Over!");
                    document.getElementById('game-over').style.display = 'flex';
                }
            }

        function filterZero(row) {
            return row.filter(num => num != 0) // create new array without zeros
        }

        function slide(row) {
            row = filterZero(row); // getting rid of zeros

            //slide
            for (let i = 0; i < (row.length - 1); i++) {
                if (row[i] == row[i + 1]) {
                    row[i] *= 2;
                    row[i + 1] = 0;
                    score += row[i];
                }
            }

            row = filterZero(row);

            // add zeros
            while (row.length < columns) {
                row.push(0);
            }
            return row;
        }

        // function slideLeft() {
        //     for (let r = 0; r < rows; r++) {
        //         let row = board[r];
        //         row = slide(row);
        //         board[r] = row;

        //         for (let c = 0; c < columns; c++) {
        //             let tile = document.getElementById(r.toString() + "-" + c.toString());
        //             let num = board[r][c];
        //             updateTile(tile, num);
        //         }
        //     }
        // }

        function slideLeft() {
            let moved = false; // Variable to track if any tile moved
            for (let r = 0; r < rows; r++) {
                let row = board[r];
                let originalRow = row.slice(); // Make a copy of the original row
                row = slide(row);
                
                if (JSON.stringify(originalRow) !== JSON.stringify(row)) {
                    moved = true; // If the row has changed, set moved to true
                }

                board[r] = row;
                for (let c = 0; c < columns; c++) {
                    let tile = document.getElementById(r.toString() + "-" + c.toString());
                    let num = board[r][c];
                    updateTile(tile, num);
                }
            }
            return moved; // Return whether any tile has moved
        }

        // function slideRight() {
        //     for (let r = 0; r < rows; r++) {
        //         let row = board[r];
        //         row.reverse(); // [0, 2, 2, 2] -> [2, 2, 2, 0]
        //         row = slide(row); // [4, 2, 0, 0]
        //         board[r] = row.reverse(); // [0, 0, 2, 4]

        //         for (let c = 0; c < columns; c++) {
        //             let tile = document.getElementById(r.toString() + "-" + c.toString());
        //             let num = board[r][c];
        //             updateTile(tile, num);
        //         }
        //     }
        // }

        function slideRight() {
            let moved = false; // Variable to track if any tile moved
            for (let r = 0; r < rows; r++) {
                let row = board[r];
                let originalRow = row.slice(); // Make a copy of the original row
                
                row.reverse();
                row = slide(row);
                row.reverse();
                
                if (JSON.stringify(originalRow) !== JSON.stringify(row)) {
                    moved = true; // If the row has changed, set moved to true
                }

                board[r] = row;
                for (let c = 0; c < columns; c++) {
                    let tile = document.getElementById(r.toString() + "-" + c.toString());
                    let num = board[r][c];
                    updateTile(tile, num);
                }
            }
            return moved; // Return whether any tile has moved
        }


        function slideUp() {
            let moved = false;
            for (let c = 0; c < columns; c++) {
                let row = [board[0][c], board[1][c], board[2][c], board[3][c]];
                let originalRow = row.slice(); // Make a copy of the original row

                row = slide(row);

                if (JSON.stringify(originalRow) !== JSON.stringify(row)) {
                    moved = true;
                }

                for (let r = 0; r < rows; r++) {
                    board[r][c] = row[r];
                    let tile = document.getElementById(r.toString() + "-" + c.toString());
                    let num = board[r][c];
                    updateTile(tile, num);
                }
            }
            return moved; // whether any tiles have moved
        }

        function slideDown() {
            let moved = false;
            for (let c = 0; c < columns; c++) {
                let row = [board[0][c], board[1][c], board[2][c], board[3][c]];
                let originalRow = row.slice(); // Make a copy of the original row

                row.reverse();
                row = slide(row);
                row.reverse();

                if (JSON.stringify(originalRow) !== JSON.stringify(row)) {
                    moved = true;
                }

                for (let r = 0; r < rows; r++) {
                    board[r][c] = row[r];
                    let tile = document.getElementById(r.toString() + "-" + c.toString());
                    let num = board[r][c];
                    updateTile(tile, num);
                }
            }
            return moved;
        }

        function setTwo() {
            if (!hasEmptyTile()) {
                return;
            }
            let found = false;
            while (!found) {
                let r = Math.floor(Math.random() * rows);
                let c = Math.floor(Math.random() * columns);
                if (board[r][c] == 0) {
                    board[r][c] = 2;
                    let tile = document.getElementById(r.toString() + "-" + c.toString());
                    tile.innerText = "2";
                    tile.classList.add("x2");
                    found = true;
                }
            }
        }

        function hasEmptyTile() {
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    if (board[r][c] == 0) {
                        return true;
                    }
                }
            }
            return false;
        }

        function isGameOver() {
            // check for empty tiles
            if (hasEmptyTile()) {
                return false;
            }
            // check for possible horizontal merges of tiles
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns - 1; c++) {
                    if (board[r][c] == board[r][c + 1]) {
                        return false;
                    }
                }
            }
            // check for possible vertical merges of tiles
            for (let c = 0; c < columns; c++) {
                for (let r = 0; r < rows - 1; r++) {
                    if (board[r][c] == board[r + 1][c]) {
                        return false;
                    }
                }
            }
            return true;
        }

        function resetGame() {
            highScores.push(score);
            highScores.sort((a, b) => b - a);
            highScores = highScores.slice(0, 5); // Keep only top 5 scores
            updateHighScoreBoard();

            score = 0;
            document.getElementById("score").innerText = score;
            document.getElementById('game-over').style.display = 'none';
            setGame();
        }

        function confirmNewGame() {
            if (confirm("Are you sure you want to start a new game?")) {
                score = 0;
                setGame(); 
            }
        }

        function updateHighScoreBoard() {
            const highscoreTable = document.getElementById('highscore-table').getElementsByTagName('tbody')[0];
            highscoreTable.innerHTML = ""; // Clear the table

            highScores.forEach((score, index) => {
                let row = highscoreTable.insertRow();
                let cell1 = row.insertCell(0);
                let cell2 = row.insertCell(1);
                cell1.innerText = index + 1;
                cell2.innerText = score;
            });
        }
    </script>
</body>
</html>
